---
- name: create the dspace postgresql role
  postgresql_user:
    name: dspace
    db: dspace
    encrypted: yes
    role_attr_flags: '{{ application_dbuser_role_attr_flags }}'
    state: 'present'

# This is not idempotent
#- name: enable the pgcrypto extension for PostgreSQL
#  postgresql_query:
#    db: dspace
#    query: "CREATE EXTENSION pgcrypto;"

- name: create the DSpace configuration file
  template:
    src: 'local.cfg.j2'
    dest: "{{ dspace_source }}/local.cfg"

- name: create the DSpace home directory
  file:
    path: "{{ dspace_home }}"
    state: directory
    mode: '0755'
    owner: dspace
    group: dspace

- name: build the Maven package
  shell:
    chdir: "{{ dspace_source }}"
    cmd: "mvn package"

- name: install DSpace using Ant
  shell:
    chdir: "{{ dspace_source }}/dspace/target/dspace-installer"
    cmd: "ant fresh_install"

- name: create the Tomcat servlet contexts for the DSpace web apps
  template:
    src: 'dspace_app_context.xml.js2'
    dest: "{{ tomcat8_home }}/conf/Catalina/localhost/{{ item }}.xml"
  loop:
    - jspui
    - solr
    - oai
    - rest
    - sword
    - swordv2

- name: create the DSpace admin. account
  shell:
    cmd: "{{ dspace_home }}/bin/dspace create-administrator"
    notify: tomcat8

